<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="JavaScript/TypeScript implementation of the Impossible Bridge Book" />
  <meta charset="utf-8">
  <title>The Impossible Bridge Book: JavaScript edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Thomas Andrews">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/no-table.css">
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
</head>

<body>
  <h1>The Impossible Bridge Book</h1>
  <h2>JavaScript Edition</h2>
<div class="container">
 <form name="lookup" id='lookup' onsubmit='return false;'>
Page Number(s):
 <div>
  <input type='text' id='pageNo' name='pageNumbers' maxlength='1000'  size='70'></input>
  </div><div>
 <select name="scramble">
    <option value="">Normal</option>
    <option value="Scrambled">Scrambled</option>
 </select>
 <select name="edition">
    <option value="Andrews">Andrews Edition</option>
    <option value="Pavlicek">Pavlicek Edition</option>
 </select>
<input type="submit" value="Lookup"></input> 
</div>

</form>
<div id='error'></div>
<div style='display: none;' id='deal'>
  <h3><a href='#' id='back'>&lt;&lt;</a>
    Deal <span id='dealIndex'></span> of <span id='dealCount'></span> 
    <a href='#' id='forward'>&gt;&gt;</a></h3>

  <h1>Page <span id='pageNumber'></span> of <span id='bookTitle'></span></h1>
  <div class="diagram">
    <div class="hand north">
    <div class="holding spades"><span  class="holding"></span></div>
    <div class="holding hearts"><span  class="holding"></span></div>
    <div class="holding diamonds"><span class="holding"></span></div>
    <div class="holding clubs"><span  class="holding"></span></div>
    </div>
    <div class="hand west">
      <div class="holding spades"><span  class="holding"></span></div>
      <div class="holding hearts"><span  class="holding"></span></div>
      <div class="holding diamonds"><span class="holding"></span></div>
      <div class="holding clubs"><span  class="holding"></span></div>
      </div>
    <div class="hand east">
      <div class="holding spades"><span  class="holding"></span></div>
      <div class="holding hearts"><span  class="holding"></span></div>
      <div class="holding diamonds"><span class="holding"></span></div>
      <div class="holding clubs"><span  class="holding"></span></div>
      </div>
    <div class="hand south">
      <div class="holding spades"><span  class="holding"></span></div>
      <div class="holding hearts"><span  class="holding"></span></div>
      <div class="holding diamonds"><span class="holding"></span></div>
      <div class="holding clubs"><span  class="holding"></span></div>
      </div>
    </div>
    
  <div><button id='reset'>Reset</button></div>
</div>
</div>
<div class="footer">
  <div><a href='https://github.com/thomasoa/IBBJS'>Git repository</a> by Thomas Andrews</div>
  <div>The <a href='https://bridge.thomasoandrews.com/impossible'>original,</a> written in Perl.</div>
  </div>
<script type="module">

      import { Application } from "./model/application.js"
      var App = new Application()

      function backDeal() {
        App.previousDeal()
        return false;
      }

      function fowardDeal() {
        App.nextDeal()
        return false;
      }
      function visibility(flag) {
        return flag ? 'visible' : 'hidden'
      }

      function setVisibility(selector,flag) {
        $(selector).css('visibility',visibility(flag))
      }

      function updateCurrentDeal(index,dealInfo) {
          var dealLoc = $('#deal')
          if (dealInfo == undefined) {
            dealLoc.hide()
            return
          } else {
            $('#dealIndex').text(index+1)
            var title = dealInfo.edition + " Edition"
            if (dealInfo.scrambled) {
              title = "Scrambled "+ title
            }
            $('#bookTitle').text(title)
            $('#error').hide()
            $('#pageNumber').text(dealInfo.pageNo)
            setVisibility('#back',App.allowPrevious)
            setVisibility('#forward',App.allowNext)
            //$('#back').toggle(App.allowPrevious)
            //$('#forward').toggle(App.allowNext)
            dealInfo.deal.eachHand((seat,hand) => {
              var handDiv = $('.diagram .'+seat.name)
              hand.eachSuit((suit,holding) => {
                var hString = holding.toString()
                if (hString=='-')  { hString = '\u2014' }
                handDiv.find('.'+suit.name+ ' span.holding').text(hString)
              })
            })
            // var hands = dealInfo.deal.hands.map((hand) => hand.toString()).join("\n")
            dealLoc.show()
          }
      }

      function updateDealCount(count) {
        $('#dealCount').text(count)
      }
      
      function reset() {
        App.reset()
          $('#lookup').find('input[name="pageNumbers"]').val('')

      }
      function initialize() {
          App.listenCurrentDeal(updateCurrentDeal)
          App.listenDealCount(updateDealCount)
          const form = $('#lookup')
          form.submit(() => {
              submit_pages(form)
              return false;
          }) 
          $('#reset').on('click',() => reset())
          $('#back').on('click',() => backDeal())
          $('#forward').on('click',() => fowardDeal())
          App.reset()
      }

      function submitPages(form,pageNumbers) {
        var scramble = form.find('select[name="scramble"]').val()
          var edition = form.find('select[name="edition"]').val()
          App.findDeals(edition,scramble=='Scrambled',pageNumbers)
      }

      function submit_pages(form) {
        try {
          var pageEntry = form.find('input[name="pageNumbers"]')
          var pageText = $(pageEntry).val()
          var pages = pageText.split(',').map((page)=> BigInt(page))
          submitPages(form,pages)
          $(pageEntry).val('')
          $('#error').hide()
        } catch (e) {

          console.error(e)
          $('#error').text(e)
          $('#error').show()
          return false

        }
      }

      $(document).ready(() => initialize())

</script>

</body>
</html>


